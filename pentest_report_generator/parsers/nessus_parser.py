"""
Nessus Parser
Extracts vulnerability information from Nessus .nessus XML files
"""
import xml.etree.ElementTree as ET
from typing import List, Dict

class NessusParser:
    def __init__(self, nessus_file):
        self.nessus_file = nessus_file
        
    def parse(self) -> List[Dict]:
        """Parse Nessus .nessus XML file"""
        findings = []
        
        try:
            tree = ET.parse(self.nessus_file)
            root = tree.getroot()
            
            # Iterate through all report hosts
            for report_host in root.findall('.//ReportHost'):
                host_ip = report_host.get('name', 'Unknown')
                
                # Extract all report items (vulnerabilities)
                for item in report_host.findall('.//ReportItem'):
                    finding = self._parse_report_item(host_ip, item)
                    if finding:
                        findings.append(finding)
        
        except Exception as e:
            print(f"Error parsing Nessus file: {str(e)}")
        
        return findings
    
    def _parse_report_item(self, host_ip, item):
        """Parse individual Nessus report item"""
        
        # Get basic info
        plugin_id = item.get('pluginID', 'N/A')
        plugin_name = item.get('pluginName', 'Unknown Vulnerability')
        port = item.get('port', 'N/A')
        protocol = item.get('protocol', 'tcp')
        severity = item.get('severity', '0')
        
        # Convert severity number to text
        severity_map = {
            '0': 'Informational',
            '1': 'Low',
            '2': 'Medium',
            '3': 'High',
            '4': 'Critical'
        }
        severity_text = severity_map.get(severity, 'Informational')
        
        # Skip informational findings unless they're important
        if severity == '0':
            return None
        
        # Extract detailed information
        description = self._get_element_text(item, 'description')
        synopsis = self._get_element_text(item, 'synopsis')
        solution = self._get_element_text(item, 'solution')
        plugin_output = self._get_element_text(item, 'plugin_output')
        
        # Extract CVEs
        cve_ids = []
        for cve in item.findall('.//cve'):
            if cve.text:
                cve_ids.append(cve.text)
        
        # Build full description
        full_description = synopsis if synopsis else description
        if plugin_output:
            full_description += f"\n\nPlugin Output:\n{plugin_output[:500]}"
        
        return {
            'id': f"nessus-{plugin_id}-{host_ip}-{port}",
            'source': 'Nessus',
            'title': plugin_name,
            'severity': severity_text,
            'host': host_ip,
            'port': port,
            'protocol': protocol,
            'description': full_description,
            'remediation': solution if solution else 'Apply vendor patches and security updates.',
            'cve_ids': cve_ids
        }
    
    def _get_element_text(self, parent, tag_name):
        """Safely extract element text"""
        element = parent.find(tag_name)
        return element.text if element is not None and element.text else ''
