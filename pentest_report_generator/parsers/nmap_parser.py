"""
Nmap XML Parser
Extracts vulnerability and service information from Nmap XML output
"""
import xml.etree.ElementTree as ET
from typing import List, Dict
import re

class NmapParser:
    def __init__(self, xml_file):
        self.xml_file = xml_file
        self.tree = None
        self.root = None
        
    def parse(self) -> List[Dict]:
        """Parse Nmap XML file and extract findings"""
        try:
            self.tree = ET.parse(self.xml_file)
            self.root = self.tree.getroot()
        except Exception as e:
            print(f"Error parsing Nmap XML: {str(e)}")
            return []
        
        findings = []
        
        # Iterate through all hosts
        for host in self.root.findall('.//host'):
            host_ip = self._get_host_ip(host)
            
            # Extract open ports and services
            for port in host.findall('.//port'):
                port_findings = self._extract_port_info(host_ip, port)
                findings.extend(port_findings)
            
            # Extract OS detection
            os_findings = self._extract_os_info(host_ip, host)
            findings.extend(os_findings)
            
        return findings
    
    def _get_host_ip(self, host):
        """Extract host IP address"""
        address = host.find('.//address[@addrtype="ipv4"]')
        return address.get('addr') if address is not None else 'Unknown'
    
    def _extract_port_info(self, host_ip, port):
        """Extract information about open ports and services"""
        findings = []
        
        state = port.find('state')
        if state is None or state.get('state') != 'open':
            return findings
        
        port_id = port.get('portid')
        protocol = port.get('protocol', 'tcp')
        
        service = port.find('service')
        if service is not None:
            service_name = service.get('name', 'unknown')
            product = service.get('product', '')
            version = service.get('version', '')
            
            # Determine severity based on service and version
            severity = self._determine_severity(service_name, version)
            
            title = f"Open Port: {service_name.upper()}"
            if product:
                title += f" ({product}"
                if version:
                    title += f" {version}"
                title += ")"
            
            description = f"Port {port_id}/{protocol} is open and running {service_name}"
            if product:
                description += f" ({product}"
                if version:
                    description += f" version {version}"
                description += ")"
            
            # Check for script output (vulnerabilities)
            scripts = port.findall('.//script')
            for script in scripts:
                script_id = script.get('id')
                script_output = script.get('output', '')
                
                if self._is_vulnerability_script(script_id):
                    findings.append({
                        'id': f"nmap-{script_id}-{host_ip}-{port_id}",
                        'source': 'Nmap',
                        'title': f"Vulnerability: {script_id.replace('-', ' ').title()}",
                        'severity': 'High',
                        'host': host_ip,
                        'port': port_id,
                        'protocol': protocol,
                        'description': script_output[:500],
                        'remediation': self._get_remediation(script_id),
                        'cve_ids': self._extract_cves(script_output)
                    })
            
            # Add service finding
            findings.append({
                'id': f"nmap-service-{host_ip}-{port_id}",
                'source': 'Nmap',
                'title': title,
                'severity': severity,
                'host': host_ip,
                'port': port_id,
                'protocol': protocol,
                'description': description,
                'remediation': f"Review if {service_name} service on port {port_id} is necessary. Ensure it's properly configured and patched.",
                'cve_ids': []
            })
        
        return findings
    
    def _extract_os_info(self, host_ip, host):
        """Extract OS detection information"""
        findings = []
        
        os_match = host.find('.//osmatch')
        if os_match is not None:
            os_name = os_match.get('name', 'Unknown OS')
            accuracy = os_match.get('accuracy', '0')
            
            findings.append({
                'id': f"nmap-os-{host_ip}",
                'source': 'Nmap',
                'title': f"Operating System: {os_name}",
                'severity': 'Informational',
                'host': host_ip,
                'port': 'N/A',
                'protocol': 'N/A',
                'description': f"Detected OS: {os_name} (Accuracy: {accuracy}%)",
                'remediation': 'Ensure operating system is up-to-date with latest security patches.',
                'cve_ids': []
            })
        
        return findings
    
    def _determine_severity(self, service_name, version):
        """Determine severity based on service type"""
        high_risk_services = ['telnet', 'ftp', 'rlogin', 'rexec']
        medium_risk_services = ['http', 'https', 'ssh', 'smtp', 'mysql', 'postgresql']
        
        if service_name.lower() in high_risk_services:
            return 'High'
        elif service_name.lower() in medium_risk_services:
            return 'Medium'
        else:
            return 'Low'
    
    def _is_vulnerability_script(self, script_id):
        """Check if script indicates a vulnerability"""
        vuln_keywords = ['vuln', 'exploit', 'backdoor', 'injection', 'xss', 'csrf']
        return any(keyword in script_id.lower() for keyword in vuln_keywords)
    
    def _extract_cves(self, text):
        """Extract CVE IDs from text"""
        cve_pattern = r'CVE-\d{4}-\d{4,7}'
        return re.findall(cve_pattern, text)
    
    def _get_remediation(self, script_id):
        """Get remediation advice based on script ID"""
        remediations = {
            'ssl-cert': 'Update SSL/TLS certificate with a valid, properly signed certificate.',
            'ssl-poodle': 'Disable SSLv3 protocol and use TLS 1.2 or higher.',
            'http-vuln': 'Apply security patches and updates to the web server.',
            'smb-vuln': 'Apply Microsoft security patches and disable SMBv1.',
        }
        
        for key, value in remediations.items():
            if key in script_id:
                return value
        
        return 'Review the vulnerability details and apply appropriate security patches.'
