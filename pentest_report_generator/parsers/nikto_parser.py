"""
Nikto Parser - Enhanced with CVE Detection
"""
import xml.etree.ElementTree as ET
import re
from typing import List, Dict

class NiktoParser:
    def __init__(self, file_path):
        self.file_path = file_path
        self.is_xml = file_path.endswith('.xml')
        
    def parse(self) -> List[Dict]:
        """Parse Nikto output"""
        if self.is_xml:
            return self._parse_xml()
        else:
            return self._parse_text()
    
    def _parse_xml(self) -> List[Dict]:
        """Parse Nikto XML"""
        findings = []
        
        try:
            tree = ET.parse(self.file_path)
            root = tree.getroot()
            
            for scandetails in root.findall('.//scandetails'):
                target_ip = scandetails.get('targetip', 'Unknown')
                target_port = scandetails.get('targetport', '80')
                
                for item in scandetails.findall('.//item'):
                    osvdb_id = item.get('id', 'N/A')
                    method = item.get('method', 'GET')
                    
                    description = item.findtext('description', 'No description')
                    uri = item.findtext('uri', '/')
                    
                    severity = self._determine_severity(description)
                    cve_ids = self._extract_cves(description)
                    
                    findings.append({
                        'id': f"nikto-{osvdb_id}-{target_ip}",
                        'source': 'Nikto',
                        'title': f"Web Vulnerability: {description[:100]}",
                        'severity': severity,
                        'host': target_ip,
                        'port': target_port,
                        'protocol': 'http',
                        'description': f"Method: {method}, URI: {uri}\n{description}",
                        'remediation': self._get_remediation(description),
                        'cve_ids': cve_ids
                    })
        
        except Exception as e:
            print(f"Error parsing Nikto XML: {str(e)}")
        
        return findings
    
    def _parse_text(self) -> List[Dict]:
        """Parse Nikto text"""
        findings = []
        
        try:
            with open(self.file_path, 'r') as f:
                content = f.read()
            
            target_match = re.search(r'Target IP:\s+(\S+)', content)
            target_ip = target_match.group(1) if target_match else 'Unknown'
            
            port_match = re.search(r'Target Port:\s+(\d+)', content)
            target_port = port_match.group(1) if port_match else '80'
            
            lines = content.split('\n')
            for i, line in enumerate(lines):
                if line.strip().startswith('+'):
                    description = line.strip()[1:].strip()
                    
                    if len(description) < 10:
                        continue
                    
                    severity = self._determine_severity(description)
                    cve_ids = self._extract_cves(description)
                    
                    findings.append({
                        'id': f"nikto-{target_ip}-{i}",
                        'source': 'Nikto',
                        'title': f"Web Issue: {description[:80]}",
                        'severity': severity,
                        'host': target_ip,
                        'port': target_port,
                        'protocol': 'http',
                        'description': description,
                        'remediation': self._get_remediation(description),
                        'cve_ids': cve_ids
                    })
        
        except Exception as e:
            print(f"Error parsing Nikto text: {str(e)}")
        
        return findings
    
    def _determine_severity(self, description):
        """Determine severity"""
        desc_lower = description.lower()
        
        critical = ['rce', 'remote code', 'shell', 'backdoor']
        high = ['sql injection', 'xss', 'csrf', 'auth bypass', 'directory traversal', 'cve']
        medium = ['information', 'sensitive', 'exposed', 'misconfig', 'header']
        
        for keyword in critical:
            if keyword in desc_lower:
                return 'Critical'
        
        for keyword in high:
            if keyword in desc_lower:
                return 'High'
        
        for keyword in medium:
            if keyword in desc_lower:
                return 'Medium'
        
        return 'Low'
    
    def _extract_cves(self, text):
        """Extract CVEs"""
        cve_pattern = r'CVE-\d{4}-\d{4,7}'
        return re.findall(cve_pattern, text)
    
    def _get_remediation(self, description):
        """Get remediation advice"""
        desc_lower = description.lower()
        
        if 'ssl' in desc_lower or 'tls' in desc_lower:
            return 'Configure proper SSL/TLS. Use TLS 1.2+. Install valid certificate.'
        elif 'directory' in desc_lower or 'file' in desc_lower:
            return 'Restrict directory listings. Remove sensitive files from web root.'
        elif 'header' in desc_lower:
            return 'Configure HTTP security headers (X-Frame-Options, CSP, etc)'
        elif 'version' in desc_lower or 'information' in desc_lower:
            return 'Hide version information. Disable debug modes. Remove banners.'
        elif 'injection' in desc_lower:
            return 'Implement input validation. Use parameterized queries. Escape output.'
        else:
            return 'Review and remediate per OWASP guidelines'
