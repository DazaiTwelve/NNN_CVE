"""
PDF Report Generator
Generates professional penetration testing reports
"""
from reportlab.lib.pagesizes import letter, A4
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.lib.units import inch
from reportlab.lib import colors
from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph, Spacer, PageBreak, Image
from reportlab.lib.enums import TA_CENTER, TA_LEFT, TA_JUSTIFY
from datetime import datetime
from typing import List, Dict
import os

class PDFReportGenerator:
    def __init__(self, output_filename="pentest_report.pdf"):
        self.output_filename = output_filename
        self.doc = SimpleDocTemplate(output_filename, pagesize=letter)
        self.styles = getSampleStyleSheet()
        self.story = []
        self._setup_custom_styles()
        
    def _setup_custom_styles(self):
        """Setup custom paragraph styles"""
        self.styles.add(ParagraphStyle(
            name='CustomTitle',
            parent=self.styles['Heading1'],
            fontSize=24,
            textColor=colors.HexColor('#1a1a1a'),
            spaceAfter=30,
            alignment=TA_CENTER
        ))
        
        self.styles.add(ParagraphStyle(
            name='SectionHeading',
            parent=self.styles['Heading2'],
            fontSize=16,
            textColor=colors.HexColor('#2c3e50'),
            spaceAfter=12,
            spaceBefore=12
        ))
        
    def generate_report(self, findings: List[Dict], metadata: Dict):
        """Generate complete penetration testing report"""
        
        # Cover page
        self._add_cover_page(metadata)
        
        # Executive Summary
        self._add_executive_summary(findings, metadata)
        
        # Vulnerability Summary Table
        self._add_summary_table(findings)
        
        # Detailed Findings
        self._add_detailed_findings(findings)
        
        # Recommendations
        self._add_recommendations(findings)
        
        # Build PDF
        self.doc.build(self.story)
        print(f"✓ PDF report generated: {self.output_filename}")
        
    def _add_cover_page(self, metadata):
        """Add cover page"""
        self.story.append(Spacer(1, 2*inch))
        
        title = Paragraph(
            metadata.get('report_title', 'Penetration Testing Report'),
            self.styles['CustomTitle']
        )
        self.story.append(title)
        self.story.append(Spacer(1, 0.5*inch))
        
        client_name = Paragraph(
            f"<b>Client:</b> {metadata.get('client_name', 'N/A')}",
            self.styles['Normal']
        )
        self.story.append(client_name)
        self.story.append(Spacer(1, 0.2*inch))
        
        date = Paragraph(
            f"<b>Date:</b> {metadata.get('date', datetime.now().strftime('%Y-%m-%d'))}",
            self.styles['Normal']
        )
        self.story.append(date)
        self.story.append(Spacer(1, 0.2*inch))
        
        author = Paragraph(
            f"<b>Prepared by:</b> {metadata.get('author', 'Security Team')}",
            self.styles['Normal']
        )
        self.story.append(author)
        
        self.story.append(PageBreak())
        
    def _add_executive_summary(self, findings, metadata):
        """Add executive summary section"""
        heading = Paragraph("Executive Summary", self.styles['SectionHeading'])
        self.story.append(heading)
        
        # Calculate risk metrics
        critical_count = sum(1 for f in findings if f.get('severity') == 'Critical')
        high_count = sum(1 for f in findings if f.get('severity') == 'High')
        medium_count = sum(1 for f in findings if f.get('severity') == 'Medium')
        
        summary_text = f"""
        This penetration testing assessment was conducted on {metadata.get('date', datetime.now().strftime('%Y-%m-%d'))} 
        for {metadata.get('client_name', 'the client')}. The assessment identified a total of {len(findings)} 
        security findings across the tested infrastructure.
        <br/><br/>
        <b>Key Findings:</b><br/>
        • Critical Issues: {critical_count}<br/>
        • High Severity Issues: {high_count}<br/>
        • Medium Severity Issues: {medium_count}<br/>
        <br/>
        The findings indicate that immediate attention is required for critical and high-severity vulnerabilities 
        to prevent potential security breaches.
        """
        
        summary = Paragraph(summary_text, self.styles['Normal'])
        self.story.append(summary)
        self.story.append(Spacer(1, 0.3*inch))
        
    def _add_summary_table(self, findings):
        """Add vulnerability summary table"""
        heading = Paragraph("Vulnerability Summary", self.styles['SectionHeading'])
        self.story.append(heading)
        
        # Create table data
        data = [['Severity', 'Count', 'Percentage']]
        
        severity_counts = {}
        for finding in findings:
            severity = finding.get('severity', 'Unknown')
            severity_counts[severity] = severity_counts.get(severity, 0) + 1
        
        total = len(findings)
        severity_order = ['Critical', 'High', 'Medium', 'Low', 'Informational']
        
        for severity in severity_order:
            count = severity_counts.get(severity, 0)
            percentage = (count / total * 100) if total > 0 else 0
            data.append([severity, str(count), f"{percentage:.1f}%"])
        
        # Create table
        table = Table(data, colWidths=[2*inch, 1.5*inch, 1.5*inch])
        
        # Style table
        table.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, 0), colors.grey),
            ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
            ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('FONTSIZE', (0, 0), (-1, 0), 12),
            ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
            ('BACKGROUND', (0, 1), (-1, -1), colors.beige),
            ('GRID', (0, 0), (-1, -1), 1, colors.black)
        ]))
        
        self.story.append(table)
        self.story.append(Spacer(1, 0.3*inch))
        
    def _add_detailed_findings(self, findings):
        """Add detailed findings section"""
        heading = Paragraph("Detailed Findings", self.styles['SectionHeading'])
        self.story.append(heading)
        
        severity_colors = {
            'Critical': colors.red,
            'High': colors.orange,
            'Medium': colors.yellow,
            'Low': colors.lightblue,
            'Informational': colors.lightgrey
        }
        
        for i, finding in enumerate(findings, 1):
            # Finding title with severity
            severity = finding.get('severity', 'Unknown')
            title_text = f"{i}. [{severity}] {finding.get('title', 'Unknown Vulnerability')}"
            
            title = Paragraph(title_text, self.styles['Heading3'])
            self.story.append(title)
            
            # Finding details table
            details_data = [
                ['Host', finding.get('host', 'N/A')],
                ['Port', str(finding.get('port', 'N/A'))],
                ['Source', finding.get('source', 'N/A')],
                ['Severity', severity]
            ]
            
            if finding.get('cve_ids'):
                details_data.append(['CVEs', ', '.join(finding['cve_ids'])])
            
            details_table = Table(details_data, colWidths=[1.5*inch, 4*inch])
            details_table.setStyle(TableStyle([
                ('BACKGROUND', (0, 0), (0, -1), colors.lightgrey),
                ('FONTNAME', (0, 0), (0, -1), 'Helvetica-Bold'),
                ('GRID', (0, 0), (-1, -1), 0.5, colors.grey),
                ('VALIGN', (0, 0), (-1, -1), 'TOP')
            ]))
            
            self.story.append(details_table)
            self.story.append(Spacer(1, 0.1*inch))
            
            # Description
            desc = Paragraph(f"<b>Description:</b><br/>{finding.get('description', 'No description available')}", 
                           self.styles['Normal'])
            self.story.append(desc)
            self.story.append(Spacer(1, 0.1*inch))
            
            # Remediation
            remediation = Paragraph(f"<b>Remediation:</b><br/>{finding.get('remediation', 'No remediation provided')}", 
                                  self.styles['Normal'])
            self.story.append(remediation)
            self.story.append(Spacer(1, 0.2*inch))
        
    def _add_recommendations(self, findings):
        """Add recommendations section"""
        self.story.append(PageBreak())
        
        heading = Paragraph("Recommendations", self.styles['SectionHeading'])
        self.story.append(heading)
        
        recommendations_text = """
        Based on the findings of this penetration test, the following high-level recommendations are provided:
        <br/><br/>
        1. <b>Immediate Actions:</b><br/>
           • Address all Critical and High severity vulnerabilities within 7 days<br/>
           • Implement emergency patches for systems with known exploits<br/>
           • Review and restrict unnecessary service exposure<br/>
        <br/>
        2. <b>Short-term Actions (30 days):</b><br/>
           • Remediate Medium severity vulnerabilities<br/>
           • Implement security hardening configurations<br/>
           • Update security policies and procedures<br/>
        <br/>
        3. <b>Long-term Actions:</b><br/>
           • Establish regular vulnerability scanning schedule<br/>
           • Implement security awareness training<br/>
           • Develop incident response procedures<br/>
           • Conduct periodic penetration testing<br/>
        """
        
        recommendations = Paragraph(recommendations_text, self.styles['Normal'])
        self.story.append(recommendations)
