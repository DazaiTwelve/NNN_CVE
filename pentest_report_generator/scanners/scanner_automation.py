"""
Scanner Automation Module - Ultimate Edition
Features: Speed Optimization, CVE Detection, Real-time Output, Command Explanations
"""
import subprocess
import os
from datetime import datetime
import time

class ScannerAutomation:
    def __init__(self, target_ip, output_dir="scan_results", verbose=True, ui_callback=None):
        self.target_ip = target_ip
        self.output_dir = output_dir
        self.verbose = verbose
        self.ui_callback = ui_callback
        self.timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        os.makedirs(output_dir, exist_ok=True)
        
    def _output(self, message, msg_type="info"):
        """Send output to both console and UI"""
        print(message)
        if self.ui_callback:
            self.ui_callback(message, msg_type)
    
    def _print_command_info(self, tool_name, cmd, explanation):
        """Print command with detailed explanation"""
        self._output(f"\n{'='*70}", "header")
        self._output(f"ğŸ› ï¸  {tool_name} Configuration", "header")
        self._output(f"{'='*70}", "header")
        self._output(f"ğŸ“ Target: {self.target_ip}", "info")
        self._output(f"âš¡ Command: {' '.join(cmd)}", "command")
        self._output(f"\nğŸ’¡ What this does:", "info")
        for line in explanation:
            self._output(f"   {line}", "info")
        self._output(f"{'='*70}\n", "header")
    
    def run_nmap_scan(self, scan_mode="fast"):
        """
        Run Nmap scan with CVE detection and speed optimization
        Modes: quick, fast, balanced, thorough, cve
        """
        output_file = os.path.join(self.output_dir, f"nmap_{self.target_ip}_{self.timestamp}.xml")
        
        try:
            # Speed and feature optimized configurations
            if scan_mode == "quick":
                # Quick: Top 100 ports only, fast
                cmd = [
                    "nmap",
                    "-F",                   # Fast mode (top 100 ports)
                    "-T5",                  # Insane speed
                    "--min-rate", "5000",   # Very fast packet rate
                    "-oX", output_file,
                    self.target_ip
                ]
                explanation = [
                    "âš¡ -F: Fast mode (top 100 most common ports)",
                    "ğŸš€ -T5: Insane speed (fastest)",
                    "ğŸ’¨ --min-rate 5000: Very aggressive packet sending",
                    "â±ï¸  Expected time: 5-15 seconds"
                ]
            
            elif scan_mode == "fast":
                # Fast: Top 1000 ports, aggressive timing
                cmd = [
                    "nmap",
                    "-sV",                  # Version detection
                    "-T5",                  # Insane speed
                    "--top-ports", "1000",  # Top 1000 common ports
                    "--min-rate", "5000",   # Very fast packet rate
                    "--max-retries", "1",   # Skip slow hosts quickly
                    "-oX", output_file,
                    self.target_ip
                ]
                explanation = [
                    "ğŸ” -sV: Detect service versions",
                    "âš¡ -T5: Insane timing (fastest)",
                    "ğŸ¯ --top-ports 1000: Scan only top 1000 common ports",
                    "ğŸš€ --min-rate 5000: Send 5000 packets/second minimum",
                    "â­ï¸  --max-retries 1: Skip slow hosts quickly",
                    "â±ï¸  Expected time: 10-30 seconds"
                ]
            
            elif scan_mode == "balanced":
                # Balanced: Top 1000 ports, moderate speed, scripts
                cmd = [
                    "nmap",
                    "-sV",
                    "-sC",                  # Default scripts
                    "-T4",                  # Aggressive timing
                    "--top-ports", "1000",
                    "--min-rate", "1000",
                    "-oX", output_file,
                    self.target_ip
                ]
                explanation = [
                    "ğŸ” -sV: Detect service versions",
                    "ğŸ“œ -sC: Run default vulnerability scripts",
                    "âš¡ -T4: Aggressive timing (balanced)",
                    "ğŸ¯ --top-ports 1000: Top 1000 common ports",
                    "ğŸš€ --min-rate 1000: 1000 packets/second",
                    "â±ï¸  Expected time: 30-60 seconds"
                ]
            
            elif scan_mode == "cve":
                # CVE Detection: Specialized for CVE discovery
                cmd = [
                    "nmap",
                    "-sV",
                    "--script=vuln",       # CVE vulnerability detection
                    "--script-args", "vulners.mincvss=5.0",
                    "--top-ports", "1000",
                    "-T4",
                    "-oX", output_file,
                    self.target_ip
                ]
                explanation = [
                    "ğŸ” -sV: Detect service versions",
                    "ğŸ”¥ --script=vuln: Run CVE vulnerability detection scripts",
                    "âš ï¸  vulners.mincvss=5.0: Show CVEs with score >= 5.0",
                    "ğŸ¯ --top-ports 1000: Focus on common ports",
                    "âš¡ -T4: Aggressive timing",
                    "â±ï¸  Expected time: 1-3 minutes (includes CVE checks)"
                ]
            
            else:  # thorough
                # Thorough: All ports with CVE detection (slowest)
                cmd = [
                    "nmap",
                    "-sV",
                    "-sC",
                    "--script=vuln",
                    "-T4",
                    "-p-",                  # All 65535 ports
                    "--min-rate", "1000",
                    "-oX", output_file,
                    self.target_ip
                ]
                explanation = [
                    "ğŸ” -sV: Detect service versions",
                    "ğŸ“œ -sC: Default scripts",
                    "ğŸ”¥ --script=vuln: CVE vulnerability detection",
                    "âš¡ -T4: Aggressive timing",
                    "ğŸ”Œ -p-: ALL 65,535 ports (COMPREHENSIVE!)",
                    "ğŸš€ --min-rate 1000: 1000 packets/second",
                    "â±ï¸  Expected time: 2-5 minutes (comprehensive scan)"
                ]
            
            if self.verbose:
                self._print_command_info("NMAP PORT SCANNER", cmd, explanation)
            
            start_time = time.time()
            self._output(f"â±ï¸  Starting scan at {datetime.now().strftime('%H:%M:%S')}", "info")
            self._output(f"ğŸ”„ Mode: {scan_mode.upper()}", "info")
            self._output(f"ğŸ¯ Target: {self.target_ip}", "info")
            
            if self.verbose:
                process = subprocess.Popen(
                    cmd,
                    stdout=subprocess.PIPE,
                    stderr=subprocess.PIPE,
                    universal_newlines=True
                )
                
                for line in iter(process.stdout.readline, ''):
                    if line:
                        line = line.rstrip()
                        
                        if "Starting Nmap" in line:
                            self._output(f"ğŸš€ {line}", "success")
                        elif "Nmap scan report" in line:
                            self._output(f"\nğŸ“Š {line}", "info")
                        elif "PORT" in line and "STATE" in line:
                            self._output(f"ğŸ“‹ {line}", "info")
                        elif "|_cve" in line or "CVE-" in line:
                            self._output(f"ğŸ”´ CVE FOUND: {line}", "error")
                        elif "open" in line.lower():
                            self._output(f"ğŸŸ¢ {line}", "success")
                        elif "filtered" in line.lower():
                            self._output(f"ğŸŸ¡ {line}", "warning")
                        elif "Host is up" in line:
                            self._output(f"âœ… {line}", "success")
                        elif "Nmap done" in line:
                            self._output(f"ğŸ {line}", "success")
                        else:
                            self._output(f"   {line}", "info")
                
                process.wait()
                result_code = process.returncode
            else:
                result = subprocess.run(cmd, capture_output=True, text=True, timeout=600)
                result_code = result.returncode
            
            elapsed = time.time() - start_time
            
            if result_code == 0:
                self._output(f"\nâœ… Nmap scan completed successfully!", "success")
                self._output(f"â±ï¸  Duration: {elapsed:.2f} seconds ({int(elapsed/60)}m {int(elapsed%60)}s)", "info")
                self._output(f"ğŸ’¾ Output saved to: {output_file}", "info")
                self._output(f"ğŸ“Š CVE Detection: {'ENABLED' if 'vuln' in ' '.join(cmd) else 'DISABLED'}", "info")
                return output_file
            else:
                self._output(f"\nâŒ Nmap scan failed", "error")
                return None
                
        except Exception as e:
            self._output(f"âŒ Error: {str(e)}", "error")
            return None
    
    def run_nikto_scan(self, port=80, tuning="fast"):
        """
        Run Nikto web scan with speed tuning
        tuning: fast, balanced, thorough
        """
        output_file = os.path.join(self.output_dir, f"nikto_{self.target_ip}_{self.timestamp}.xml")
        
        try:
            hostname = self.target_ip.replace('http://', '').replace('https://', '').split('/')[0]
            
            if port == 443:
                target = f"https://{hostname}"
            else:
                target = f"http://{hostname}"
            
            cmd = ["nikto", "-h", target, "-Format", "xml", "-o", output_file]
            
            # Speed tuning
            if tuning == "fast":
                cmd.extend(["-Tuning", "1234567"])  # Most useful tests
                explanation_tuning = "âš¡ Fast scan (essential tests only)"
            elif tuning == "balanced":
                cmd.extend(["-Tuning", "123456789"])  # All tests except dangerous
                explanation_tuning = "âš–ï¸ Balanced scan (most tests)"
            else:  # thorough
                explanation_tuning = "ğŸ” Thorough scan (all tests)"
            
            if port not in [80, 443]:
                cmd.extend(["-port", str(port)])
            
            explanation = [
                f"ğŸŒ Target: {target}",
                f"ğŸ” Scanning for web vulnerabilities, misconfigurations",
                explanation_tuning,
                f"ğŸ”Œ Port: {port} ({'HTTPS' if port == 443 else 'HTTP'})",
                "ğŸ” Checks: Security headers, dangerous files, outdated software",
                "â±ï¸  Expected time: 30-120 seconds"
            ]
            
            if self.verbose:
                self._print_command_info("NIKTO WEB SCANNER", cmd, explanation)
            
            start_time = time.time()
            self._output(f"â±ï¸  Starting scan at {datetime.now().strftime('%H:%M:%S')}", "info")
            self._output(f"ğŸ”„ Tuning: {tuning.upper()}", "info")
            self._output(f"ğŸŒ Target: {target}", "info")
            
            if self.verbose:
                process = subprocess.Popen(
                    cmd,
                    stdout=subprocess.PIPE,
                    stderr=subprocess.STDOUT,
                    universal_newlines=True
                )
                
                test_count = 0
                cve_count = 0
                for line in iter(process.stdout.readline, ''):
                    if line:
                        line = line.rstrip()
                        
                        if "Target IP:" in line:
                            self._output(f"ğŸ¯ {line}", "info")
                        elif "Target Hostname:" in line:
                            self._output(f"ğŸŒ {line}", "info")
                        elif "Server:" in line:
                            self._output(f"ğŸ–¥ï¸  {line}", "info")
                        elif line.startswith("+ /"):
                            test_count += 1
                            if "OSVDB" in line or "CVE" in line:
                                cve_count += 1
                                self._output(f"ğŸ”´ VULNERABILITY #{test_count}: {line}", "error")
                            elif "header" in line.lower():
                                self._output(f"ğŸŸ¡ HEADER #{test_count}: {line}", "warning")
                            else:
                                self._output(f"ğŸ”µ FINDING #{test_count}: {line}", "info")
                        elif "ERROR" in line:
                            self._output(f"âŒ {line}", "error")
                        elif "**" in line:
                            self._output(f"âš ï¸  {line}", "warning")
                        else:
                            self._output(f"   {line}", "info")
                
                process.wait()
            else:
                subprocess.run(cmd, capture_output=True, timeout=600)
            
            elapsed = time.time() - start_time
            
            if os.path.exists(output_file) and os.path.getsize(output_file) > 0:
                self._output(f"\nâœ… Nikto scan completed!", "success")
                self._output(f"â±ï¸  Duration: {elapsed:.2f} seconds ({int(elapsed/60)}m {int(elapsed%60)}s)", "info")
                self._output(f"ğŸ’¾ Output: {output_file}", "info")
                self._output(f"ğŸ“Š Total findings: {test_count}", "info")
                self._output(f"ğŸ”´ CVE-related findings: {cve_count}", "warning" if cve_count > 0 else "info")
                return output_file
            else:
                self._output(f"\nâš ï¸  Nikto produced no output", "warning")
                return None
                
        except Exception as e:
            self._output(f"âŒ Error: {str(e)}", "error")
            return None
    
    def run_nessus_scan(self):
        """Nessus placeholder with features info"""
        self._output(f"\n{'='*70}", "header")
        self._output(f"ğŸ” NESSUS PROFESSIONAL SCANNER", "header")
        self._output(f"{'='*70}", "header")
        self._output(f"âš ï¸  Status: Requires API Configuration", "warning")
        self._output(f"\nğŸ’¡ Nessus Features:", "info")
        self._output(f"   ğŸ” Comprehensive vulnerability assessment", "info")
        self._output(f"   ğŸ“Š CVE-based vulnerability detection", "info")
        self._output(f"   ğŸ” Compliance checking (PCI-DSS, HIPAA, etc)", "info")
        self._output(f"   ğŸŒ Network and web application scanning", "info")
        self._output(f"   ğŸ”¥ Malware detection", "info")
        self._output(f"\nğŸ“ To use Nessus:", "info")
        self._output(f"   1. Install Nessus Professional/Essentials", "info")
        self._output(f"   2. Configure API credentials in app", "info")
        self._output(f"   3. Or upload existing .nessus report files in the UI", "info")
        self._output(f"{'='*70}\n", "header")
        return None
    
    def run_selected_scans(self, tools=None, nmap_mode="fast", nikto_port=80, nikto_tuning="fast"):
        """Run selected scans with advanced options"""
        if tools is None:
            tools = ['nmap', 'nikto']
        
        self._output(f"\n{'#'*70}", "header")
        self._output(f"ğŸš€ PENETRATION TEST INITIATED", "header")
        self._output(f"{'#'*70}", "header")
        self._output(f"ğŸ¯ Target: {self.target_ip}", "info")
        self._output(f"ğŸ› ï¸  Tools: {', '.join([t.upper() for t in tools])}", "info")
        self._output(f"âš¡ Nmap Mode: {nmap_mode.upper()}", "info")
        self._output(f"ğŸŒ Nikto Tuning: {nikto_tuning.upper()}", "info")
        self._output(f"ğŸ” CVE Detection: ENABLED" if nmap_mode in ['cve', 'thorough'] else "ğŸ” CVE Detection: BASIC", "info")
        self._output(f"â° Start: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}", "info")
        self._output(f"{'#'*70}\n", "header")
        
        results = {}
        total_tools = len(tools)
        completed = 0
        
        if 'nmap' in tools:
            self._output(f"\n[{completed + 1}/{total_tools}] ğŸ” NMAP PORT SCANNING", "header")
            self._output(f"{'â”€'*70}", "header")
            results['nmap'] = self.run_nmap_scan(scan_mode=nmap_mode)
            completed += 1
        
        if 'nikto' in tools:
            self._output(f"\n[{completed + 1}/{total_tools}] ğŸŒ NIKTO WEB SCANNING", "header")
            self._output(f"{'â”€'*70}", "header")
            results['nikto'] = self.run_nikto_scan(port=nikto_port, tuning=nikto_tuning)
            completed += 1
        
        if 'nessus' in tools:
            self._output(f"\n[{completed + 1}/{total_tools}] ğŸ” NESSUS ASSESSMENT", "header")
            self._output(f"{'â”€'*70}", "header")
            results['nessus'] = self.run_nessus_scan()
            completed += 1
        
        success_count = sum(1 for r in results.values() if r)
        
        self._output(f"\n{'#'*70}", "header")
        self._output(f"ğŸ“Š SCAN COMPLETE", "header")
        self._output(f"{'#'*70}", "header")
        self._output(f"âœ… Success: {success_count}/{total_tools} tools completed", "success")
        self._output(f"ğŸ“ˆ Success Rate: {int(success_count/total_tools*100)}%", "info")
        self._output(f"â° End: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}", "info")
        self._output(f"{'#'*70}\n", "header")
        
        return results
    
    def run_all_scans(self, nikto_port=80):
        """Legacy method - uses FAST mode by default"""
        return self.run_selected_scans(
            tools=['nmap', 'nikto'],
            nmap_mode='fast',
            nikto_port=nikto_port,
            nikto_tuning='fast'
        )
