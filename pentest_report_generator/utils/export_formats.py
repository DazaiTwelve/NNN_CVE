"""
Export Formats - CSV, HTML, JSON, XML
"""
import csv
import json
from typing import List, Dict
from datetime import datetime

class ExportFormats:
    def __init__(self, findings: List[Dict], target: str):
        self.findings = findings
        self.target = target
        self.timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
    
    def export_csv(self) -> str:
        """Export to CSV"""
        filename = f"findings_{self.timestamp}.csv"
        
        with open(filename, 'w', newline='') as f:
            writer = csv.DictWriter(f, fieldnames=[
                'host', 'port', 'severity', 'title', 'description',
                'remediation', 'source', 'cve_ids'
            ])
            writer.writeheader()
            
            for finding in self.findings:
                writer.writerow({
                    'host': finding.get('host'),
                    'port': finding.get('port'),
                    'severity': finding.get('severity'),
                    'title': finding.get('title'),
                    'description': finding.get('description', '')[:200],
                    'remediation': finding.get('remediation', '')[:200],
                    'source': finding.get('source'),
                    'cve_ids': ','.join(finding.get('cve_ids', []))
                })
        
        return filename
    
    def export_html(self) -> str:
        """Export to HTML"""
        filename = f"findings_{self.timestamp}.html"
        
        html = f"""
        <html>
        <head>
            <title>Penetration Test Report - {self.target}</title>
            <style>
                body {{ font-family: Arial; margin: 20px; }}
                .critical {{ color: red; }}
                .high {{ color: orange; }}
                .medium {{ color: goldenrod; }}
                table {{ border-collapse: collapse; width: 100%; }}
                th, td {{ border: 1px solid #ddd; padding: 8px; text-align: left; }}
                th {{ background-color: #4CAF50; color: white; }}
            </style>
        </head>
        <body>
            <h1>Penetration Test Report</h1>
            <p><strong>Target:</strong> {self.target}</p>
            <p><strong>Date:</strong> {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</p>
            <p><strong>Total Findings:</strong> {len(self.findings)}</p>
            
            <table>
            <tr>
                <th>Host</th>
                <th>Port</th>
                <th>Severity</th>
                <th>Title</th>
                <th>CVEs</th>
            </tr>
        """
        
        for finding in self.findings:
            severity_class = finding.get('severity', 'Low').lower()
            cves = ', '.join(finding.get('cve_ids', []))
            
            html += f"""
            <tr>
                <td>{finding.get('host')}</td>
                <td>{finding.get('port')}</td>
                <td class="{severity_class}">{finding.get('severity')}</td>
                <td>{finding.get('title')}</td>
                <td>{cves}</td>
            </tr>
            """
        
        html += """
            </table>
        </body>
        </html>
        """
        
        with open(filename, 'w') as f:
            f.write(html)
        
        return filename
    
    def export_xml(self) -> str:
        """Export to XML"""
        filename = f"findings_{self.timestamp}.xml"
        
        xml = '<?xml version="1.0" encoding="UTF-8"?>\n'
        xml += '<pentest_report>\n'
        xml += f'  <target>{self.target}</target>\n'
        xml += f'  <date>{datetime.now().isoformat()}</date>\n'
        xml += f'  <total_findings>{len(self.findings)}</total_findings>\n'
        xml += '  <findings>\n'
        
        for finding in self.findings:
            xml += '    <finding>\n'
            xml += f'      <host>{finding.get("host")}</host>\n'
            xml += f'      <port>{finding.get("port")}</port>\n'
            xml += f'      <severity>{finding.get("severity")}</severity>\n'
            xml += f'      <title>{finding.get("title")}</title>\n'
            xml += f'      <source>{finding.get("source")}</source>\n'
            
            for cve in finding.get('cve_ids', []):
                xml += f'      <cve>{cve}</cve>\n'
            
            xml += '    </finding>\n'
        
        xml += '  </findings>\n'
        xml += '</pentest_report>\n'
        
        with open(filename, 'w') as f:
            f.write(xml)
        
        return filename
