"""
Notification System - Slack and Email Alerts
"""
import requests
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from typing import List, Dict

class NotificationSystem:
    def __init__(self):
        pass
    
    def send_slack_alert(self, webhook_url: str, findings: List[Dict], target: str):
        """Send Slack notification of critical findings"""
        critical = [f for f in findings if f.get('severity') == 'Critical']
        high = [f for f in findings if f.get('severity') == 'High']
        
        message = {
            "text": f"ðŸš¨ Penetration Test Alert - {target}",
            "blocks": [
                {
                    "type": "header",
                    "text": {
                        "type": "plain_text",
                        "text": f"Penetration Test Report: {target}"
                    }
                },
                {
                    "type": "section",
                    "fields": [
                        {
                            "type": "mrkdwn",
                            "text": f"ðŸ”´ Critical: {len(critical)}"
                        },
                        {
                            "type": "mrkdwn",
                            "text": f"ðŸŸ  High: {len(high)}"
                        }
                    ]
                }
            ]
        }
        
        try:
            requests.post(webhook_url, json=message)
            return True
        except Exception as e:
            print(f"Slack notification failed: {str(e)}")
            return False
    
    def send_email_alert(self, smtp_config: Dict, recipients: List[str], 
                        findings: List[Dict], target: str):
        """Send email notification"""
        try:
            msg = MIMEMultipart()
            msg['From'] = smtp_config['sender']
            msg['To'] = ', '.join(recipients)
            msg['Subject'] = f"Penetration Test Report - {target}"
            
            critical = [f for f in findings if f.get('severity') == 'Critical']
            high = [f for f in findings if f.get('severity') == 'High']
            
            body = f"""
Penetration Test Report
Target: {target}

CRITICAL FINDINGS: {len(critical)}
HIGH FINDINGS: {len(high)}
TOTAL FINDINGS: {len(findings)}

Top Issues:
"""
            for finding in (critical + high)[:5]:
                body += f"\nâ€¢ {finding['title']} on {finding['host']}:{finding['port']}"
            
            msg.attach(MIMEText(body, 'plain'))
            
            server = smtplib.SMTP(smtp_config['host'], smtp_config['port'])
            server.starttls()
            server.login(smtp_config['user'], smtp_config['password'])
            server.send_message(msg)
            server.quit()
            
            return True
        except Exception as e:
            print(f"Email notification failed: {str(e)}")
            return False
