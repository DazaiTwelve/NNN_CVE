"""
Executive Summary Generator
Creates concise summaries of security findings
"""
from typing import Dict, List
from datetime import datetime

class ReportSummary:
    def __init__(self, findings: List[Dict], target: str):
        self.findings = findings
        self.target = target
        
    def generate_executive_summary(self) -> str:
        """Generate executive summary"""
        stats = self._calculate_stats()
        
        summary = f"""
PENETRATION TEST EXECUTIVE SUMMARY
Generated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
Target: {self.target}

RISK ASSESSMENT
───────────────
Critical Issues: {stats['critical']}
High Severity: {stats['high']}
Medium Severity: {stats['medium']}
Low Severity: {stats['low']}
Total Findings: {stats['total']}

Risk Score: {stats['risk_score']}/100

KEY FINDINGS
────────────
{self._format_key_findings()}

REMEDIATION PRIORITY
────────────────────
1. IMMEDIATE (Critical): {stats['critical']} issues
   - Deploy patches within 24-48 hours
   
2. URGENT (High): {stats['high']} issues
   - Deploy patches within 1 week
   
3. MEDIUM PRIORITY: {stats['medium']} issues
   - Deploy patches within 30 days

AFFECTED HOSTS
──────────────
{self._format_affected_hosts()}

RECOMMENDATIONS
───────────────
1. Establish patch management process
2. Implement vulnerability scanning schedule
3. Deploy WAF and IDS/IPS
4. Conduct security awareness training
5. Perform regular penetration testing

"""
        return summary
    
    def _calculate_stats(self) -> Dict:
        """Calculate statistics"""
        stats = {
            'critical': 0,
            'high': 0,
            'medium': 0,
            'low': 0,
            'total': len(self.findings)
        }
        
        for finding in self.findings:
            severity = finding.get('severity', 'Low')
            if severity == 'Critical':
                stats['critical'] += 1
            elif severity == 'High':
                stats['high'] += 1
            elif severity == 'Medium':
                stats['medium'] += 1
            else:
                stats['low'] += 1
        
        # Calculate risk score
        stats['risk_score'] = (
            stats['critical'] * 40 +
            stats['high'] * 20 +
            stats['medium'] * 10 +
            stats['low'] * 2
        ) // max(stats['total'], 1)
        
        return stats
    
    def _format_key_findings(self) -> str:
        """Format key findings"""
        critical = [f for f in self.findings if f.get('severity') == 'Critical']
        high = [f for f in self.findings if f.get('severity') == 'High']
        
        findings_text = ""
        for finding in (critical + high)[:5]:
            findings_text += f"• {finding['title']}\n"
        
        return findings_text or "No critical findings"
    
    def _format_affected_hosts(self) -> str:
        """Format affected hosts"""
        hosts = {}
        for finding in self.findings:
            host = finding.get('host', 'Unknown')
            hosts[host] = hosts.get(host, 0) + 1
        
        return "\n".join([f"• {host}: {count} issues" for host, count in sorted(hosts.items())])
