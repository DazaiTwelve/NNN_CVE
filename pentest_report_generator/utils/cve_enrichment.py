"""
CVE Enrichment Module - NIST NVD API Integration
Fetches CVE details from National Vulnerability Database
"""
import requests
import time
from typing import Dict, List
import json

class CVEEnrichment:
    def __init__(self, api_key=None):
        """
        Initialize CVE enrichment with optional NVD API key
        Get free key from: https://nvd.nist.gov/developers/request-an-api-key
        """
        self.api_key = api_key
        self.base_url = "https://services.nvd.nist.gov/rest/json/cves/2.0"
        self.delay = 0.6 if api_key else 6  # Rate limiting
        self.last_request = 0
        
    def _rate_limit(self):
        """Implement rate limiting to avoid API blocking"""
        elapsed = time.time() - self.last_request
        if elapsed < self.delay:
            time.sleep(self.delay - elapsed)
        self.last_request = time.time()
    
    def get_cve_details(self, cve_id: str) -> Dict:
        """Fetch CVE details from NIST NVD"""
        try:
            self._rate_limit()
            
            headers = {}
            if self.api_key:
                headers['apiKey'] = self.api_key
            
            params = {'cveId': cve_id}
            
            response = requests.get(self.base_url, headers=headers, params=params, timeout=10)
            
            if response.status_code == 200:
                data = response.json()
                if 'vulnerabilities' in data and len(data['vulnerabilities']) > 0:
                    vuln = data['vulnerabilities'][0]['cve']
                    
                    # Extract CVSS scores
                    cvss_v3 = None
                    cvss_v2 = None
                    
                    if 'metrics' in vuln:
                        if 'cvssMetricV31' in vuln['metrics']:
                            cvss_v3 = vuln['metrics']['cvssMetricV31'][0]['cvssData']
                        elif 'cvssMetricV30' in vuln['metrics']:
                            cvss_v3 = vuln['metrics']['cvssMetricV30'][0]['cvssData']
                        
                        if 'cvssMetricV2' in vuln['metrics']:
                            cvss_v2 = vuln['metrics']['cvssMetricV2'][0]['cvssData']
                    
                    # Extract description
                    description = ""
                    if 'descriptions' in vuln:
                        for desc in vuln['descriptions']:
                            if desc['lang'] == 'en':
                                description = desc['value']
                                break
                    
                    # Extract references
                    references = []
                    if 'references' in vuln:
                        references = [ref['url'] for ref in vuln['references'][:5]]
                    
                    # Extract CPE affected
                    affected_software = []
                    if 'configurations' in vuln:
                        for config in vuln['configurations'][:3]:
                            for node in config.get('nodes', []):
                                for cpe_match in node.get('cpeMatch', []):
                                    affected_software.append(cpe_match.get('criteria', ''))
                    
                    return {
                        'cve_id': cve_id,
                        'description': description,
                        'cvss_v3_score': cvss_v3['baseScore'] if cvss_v3 else None,
                        'cvss_v3_severity': cvss_v3['baseSeverity'] if cvss_v3 else None,
                        'cvss_v3_vector': cvss_v3['vectorString'] if cvss_v3 else None,
                        'cvss_v2_score': cvss_v2['baseScore'] if cvss_v2 else None,
                        'cvss_v2_severity': cvss_v2['baseSeverity'] if cvss_v2 else None,
                        'published_date': vuln.get('published', 'Unknown'),
                        'last_modified': vuln.get('lastModified', 'Unknown'),
                        'references': references,
                        'affected_software': affected_software[:3],
                        'found': True
                    }
            
            return {'cve_id': cve_id, 'found': False}
            
        except Exception as e:
            print(f"Error fetching CVE {cve_id}: {str(e)}")
            return {'cve_id': cve_id, 'found': False, 'error': str(e)}
    
    def enrich_findings(self, findings: List[Dict]) -> List[Dict]:
        """Enrich findings with CVE details from NVD"""
        enriched_findings = []
        
        for finding in findings:
            cve_ids = finding.get('cve_ids', [])
            
            if cve_ids:
                cve_details = []
                for cve_id in cve_ids[:3]:  # Limit to 3 CVEs to avoid rate limits
                    details = self.get_cve_details(cve_id)
                    if details.get('found'):
                        cve_details.append(details)
                
                finding['cve_details'] = cve_details
                
                # Update severity based on CVSS scores
                if cve_details:
                    max_score = max([d.get('cvss_v3_score', 0) or 0 for d in cve_details])
                    if max_score >= 9.0:
                        finding['severity'] = 'Critical'
                    elif max_score >= 7.0:
                        finding['severity'] = 'High'
                    elif max_score >= 4.0:
                        finding['severity'] = 'Medium'
            else:
                finding['cve_details'] = []
            
            enriched_findings.append(finding)
        
        return enriched_findings
    
    def generate_cve_report(self, findings: List[Dict]) -> Dict:
        """Generate CVE intelligence report - FIXED"""
        report = {
            'total_findings': len(findings),
            'unique_cves': set(),
            'critical_cves': [],
            'high_cves': [],
            'affected_products': set(),
            'cve_timeline': {},
            'cve_count': 0,
            'critical_count': 0,
            'high_count': 0
        }
        
        try:
            for finding in findings:
                for cve in finding.get('cve_details', []):
                    if cve.get('found'):
                        report['unique_cves'].add(cve['cve_id'])
                        
                        cvss_score = cve.get('cvss_v3_score')
                        if cvss_score:
                            if cvss_score >= 9.0:
                                report['critical_cves'].append({
                                    'id': cve['cve_id'],
                                    'score': cvss_score,
                                    'host': finding.get('host', 'Unknown'),
                                    'severity': cve.get('cvss_v3_severity', 'CRITICAL')
                                })
                                report['critical_count'] += 1
                            elif cvss_score >= 7.0:
                                report['high_cves'].append({
                                    'id': cve['cve_id'],
                                    'score': cvss_score,
                                    'host': finding.get('host', 'Unknown'),
                                    'severity': cve.get('cvss_v3_severity', 'HIGH')
                                })
                                report['high_count'] += 1
                        
                        # Track products
                        report['affected_products'].update(cve.get('affected_software', []))
                        
                        # Timeline
                        pub_date = cve.get('published_date', 'Unknown')[:7]  # YYYY-MM
                        if pub_date != 'Unknown':
                            report['cve_timeline'][pub_date] = report['cve_timeline'].get(pub_date, 0) + 1
            
            report['unique_cves'] = list(report['unique_cves'])
            report['affected_products'] = list(report['affected_products'])
            report['cve_count'] = len(report['unique_cves'])
            
        except Exception as e:
            print(f"Error generating CVE report: {str(e)}")
        
        return report
